<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Talk Gallery :: SHH-ELF</title>
    <meta name="description" content="Discover classic novels with difficulty levels, sample readings, and expert book talks. Perfect for English learners.">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-green: #00ff00;
            --dark-green: #008000;
            --bg-black: #000000;
            --bg-dark: #111111;
            --white: #ffffff;
            --gray: #333333;
            --light-gray: #666666;
        }

        body {
            font-family: 'VT323', 'Courier New', monospace;
            background: var(--bg-black);
            color: var(--primary-green);
            line-height: 1.4;
            font-size: 18px;
            overflow-x: hidden;
            cursor: crosshair;
        }

        /* Scanlines Effect */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                transparent 50%,
                rgba(0, 255, 0, 0.03) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 9999;
        }

        /* CRT Flicker */
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            98% { opacity: 0.98; }
            99% { opacity: 1; }
        }

        body {
            animation: flicker 3s infinite;
        }

        /* Header Terminal */
        .terminal-header {
            position: fixed;
            top: 0;
            width: 100%;
            background: var(--bg-black);
            border-bottom: 2px solid var(--primary-green);
            padding: 8px 16px;
            z-index: 100;
            font-size: 14px;
        }

        .terminal-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-title {
            color: var(--primary-green);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .terminal-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-right: 20px;
        }

        .user-btn {
            background: transparent;
            color: var(--primary-green);
            border: 1px solid var(--primary-green);
            padding: 4px 8px;
            font-family: 'VT323', monospace;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-btn:hover {
            background: var(--primary-green);
            color: var(--bg-black);
        }

        .username-display {
            color: var(--primary-green);
            font-size: 12px;
            text-transform: uppercase;
        }

        .nav-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-btn {
            background: transparent;
            color: var(--primary-green);
            border: 1px solid var(--primary-green);
            padding: 4px 12px;
            font-family: 'VT323', monospace;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: var(--primary-green);
            color: var(--bg-black);
        }

        /* Header Terminal */
        .terminal-header {
            position: fixed;
            top: 0;
            width: 100%;
            background: var(--bg-black);
            border-bottom: 2px solid var(--primary-green);
            padding: 8px 16px;
            z-index: 100;
            font-size: 14px;
        }

        .terminal-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-title {
            color: var(--primary-green);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .terminal-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-btn {
            background: transparent;
            color: var(--primary-green);
            border: 1px solid var(--primary-green);
            padding: 4px 12px;
            font-family: 'VT323', monospace;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: var(--primary-green);
            color: var(--bg-black);
        }

        /* Main Content */
        .main-content {
            margin-top: 40px;
            padding: 20px;
        }

        /* Book Gallery Styles */
        .book-gallery {
            margin: 20px;
            border: 3px solid var(--primary-green);
            background: var(--bg-dark);
            padding: 30px;
        }

        .gallery-header {
            text-align: center;
            font-size: 2.5rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 20px;
            color: var(--primary-green);
            text-shadow: 2px 2px 0px var(--dark-green);
        }

        .gallery-desc {
            text-align: center;
            color: var(--white);
            margin-bottom: 30px;
            font-size: 1.2rem;
            line-height: 1.6;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .filter-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: transparent;
            color: var(--primary-green);
            border: 2px solid var(--primary-green);
            padding: 10px 20px;
            font-family: 'VT323', monospace;
            font-size: 16px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 2px 2px 0px var(--dark-green);
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--primary-green);
            color: var(--bg-black);
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px var(--dark-green);
        }

        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .book-card {
            border: 2px solid var(--light-gray);
            background: var(--bg-black);
            padding: 25px;
            transition: all 0.3s;
            position: relative;
        }

        .book-card:hover {
            border-color: var(--primary-green);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
            transform: translateY(-3px);
        }

        .book-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .book-cover {
            width: 100px;
            height: 150px;
            border: 2px solid var(--light-gray);
            background: var(--gray);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .book-info {
            flex: 1;
        }

        .book-title {
            color: var(--primary-green);
            font-size: 1.5rem;
            text-transform: uppercase;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .book-author {
            color: var(--white);
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .book-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .meta-tag {
            padding: 4px 10px;
            font-size: 12px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .difficulty-tag {
            background: #ff6b6b;
            color: white;
        }

        .vocab-tag {
            background: #4ecdc4;
            color: white;
        }

        .genre-tag {
            background: var(--primary-green);
            color: var(--bg-black);
        }

        .sample-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid var(--light-gray);
            background: var(--bg-dark);
        }

        .sample-title {
            color: var(--primary-green);
            font-size: 16px;
            text-transform: uppercase;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--primary-green);
            padding-bottom: 5px;
        }

        .sample-text {
            color: var(--white);
            line-height: 1.7;
            font-style: italic;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .audio-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .audio-btn {
            background: transparent;
            color: var(--primary-green);
            border: 2px solid var(--primary-green);
            padding: 10px 15px;
            font-family: 'VT323', monospace;
            font-size: 14px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .audio-btn:hover {
            background: var(--primary-green);
            color: var(--bg-black);
        }

        .toggle-btn {
            background: transparent;
            color: var(--primary-green);
            border: 1px solid var(--primary-green);
            padding: 8px 12px;
            font-family: 'VT323', monospace;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
            border-radius: 3px;
        }

        .toggle-btn:hover {
            background: var(--primary-green);
            color: var(--bg-black);
        }

        .sample-toggle {
            margin-bottom: 10px;
        }

        .audio-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .formal-models {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid var(--dark-green);
            background: rgba(0, 128, 0, 0.1);
        }

        .formal-models-title {
            color: var(--primary-green);
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--dark-green);
            padding-bottom: 5px;
        }

        .formal-model-tag {
            display: inline-block;
            background: var(--dark-green);
            color: var(--white);
            padding: 4px 10px;
            margin: 3px;
            font-size: 11px;
            text-transform: uppercase;
            border-radius: 2px;
        }

        /* Loading and Error States */
        .loading-text, .error-text {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.3rem;
        }

        .error-text {
            color: #ff6b6b;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .books-grid {
                grid-template-columns: 1fr;
            }

            .book-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .filter-controls {
                flex-direction: column;
                align-items: center;
            }

            .audio-controls {
                flex-direction: column;
            }

            .gallery-header {
                font-size: 2rem;
            }
        }

        /* Language Switcher */
        .lang-switch {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-black);
            border: 2px solid var(--primary-green);
            color: var(--primary-green);
            padding: 8px 16px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            text-transform: uppercase;
            z-index: 1000;
        }

        .lang-switch:hover {
            background: var(--primary-green);
            color: var(--bg-black);
        }
    </style>
</head>
<body>
    <div class="terminal-header">
        <div class="terminal-bar">
            <span class="terminal-title">SHH-ELF.EXE - BOOK TALK GALLERY</span>
            <div class="terminal-controls">
                <div class="nav-controls">
                    <a href="index.html" class="nav-btn">HOME</a>
                    <a href="gallery.html" class="nav-btn">GALLERY</a>
                    <a href="playground.html" class="nav-btn">PLAYGROUND</a>
                    <a href="discovery.html" class="nav-btn">DISCOVERY</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Book Talk Gallery -->
        <section class="book-gallery">
            <div class="gallery-header">BOOK TALK GALLERY</div>
            <div class="gallery-desc">
                Discover classic novels with difficulty levels, sample readings, and expert book talks.<br>
                Perfect for English learners who want to explore literature through
                <strong>formal models</strong> and <strong>CEFR difficulty ratings</strong>.
            </div>

            <div class="filter-controls">
                <button class="filter-btn active" onclick="filterBooks('all')">ALL BOOKS</button>
                <button class="filter-btn" onclick="filterBooks('B1')">B1 LEVEL</button>
                <button class="filter-btn" onclick="filterBooks('B2')">B2 LEVEL</button>
            </div>

            <div id="booksGrid" class="books-grid">
                <div class="loading-text">🔄 LOADING BOOK GALLERY...</div>
            </div>
        </section>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://shh-elf.onrender.com';

        // Book Gallery Functions
        let allBooks = [];
        let currentFilter = 'all';

        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };

            const finalOptions = { ...defaultOptions, ...options };
            const response = await fetch(url, finalOptions);

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
            }

            return response.json();
        }

        async function loadBookGallery() {
            try {
                const response = await apiRequest('/api/book-gallery');
                allBooks = response.books;

                // Display books immediately for fast loading
                displayBooks(allBooks);
                hideAudioLoadingMessage();

                // Generate audio in background if needed (non-blocking)
                if (response.audio_cache_empty) {
                    console.log('🎵 Audio cache is empty, generating audio in background...');
                    generateGalleryAudio().catch(error => {
                        console.warn('Background audio generation failed:', error);
                        // Audio generation failure doesn't affect gallery display
                    });
                }
            } catch (error) {
                console.error('Failed to load book gallery:', error);
                document.getElementById('booksGrid').innerHTML =
                    '<div class="error-text">❌ Failed to load book gallery<br>Please try again later.</div>';
                hideAudioLoadingMessage();
            }
        }

        async function generateGalleryAudio() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/generate-gallery-audio`);
                if (!response.ok) {
                    throw new Error(`Audio generation failed: ${response.status}`);
                }
                const result = await response.json();
                console.log('✅ Gallery audio generated successfully:', result.message);
                return result;
            } catch (error) {
                console.error('Failed to generate gallery audio:', error);
                throw error;
            }
        }

        function showAudioLoadingMessage() {
            const grid = document.getElementById('booksGrid');
            grid.innerHTML = `
                <div class="loading-message" style="text-align: center; padding: 40px; color: var(--primary-green);">
                    <div style="font-size: 2em; margin-bottom: 20px;">🎵</div>
                    <div style="font-size: 1.5em; margin-bottom: 10px;">GENERATING AUDIO...</div>
                    <div style="color: var(--light-gray);">This may take a moment. First-time setup for optimal experience.</div>
                </div>
            `;
        }

        function hideAudioLoadingMessage() {
            // Loading message will be replaced by actual books
        }

        function displayBooks(books) {
            const grid = document.getElementById('booksGrid');
            if (books.length === 0) {
                grid.innerHTML = '<div class="error-text">📚 No books found for this filter</div>';
                return;
            }

            grid.innerHTML = books.map(book => `
                <div class="book-card" data-cefr="${book.cefr_level}">
                    <div class="book-header">
                        <div class="book-cover">
                            <img src="${book.cover_url}" alt="${book.title}"
                                 onerror="this.style.display='none'; this.parentElement.innerHTML='📚';">
                        </div>
                        <div class="book-info">
                            <div class="book-title">${book.title}</div>
                            <div class="book-author">by ${book.author}</div>
                            <div class="book-meta">
                                <span class="meta-tag difficulty-tag">${book.cefr_level} Level</span>
                                <span class="meta-tag vocab-tag">${book.estimated_vocabulary.toLocaleString()} Words</span>
                                <span class="meta-tag genre-tag">${book.genre}</span>
                            </div>
                        </div>
                    </div>

                    <div class="sample-section">
                        <div class="sample-title">Sample Paragraph</div>
                        <div class="sample-toggle">
                            <button class="toggle-btn" onclick="toggleSampleText(this)">
                                Show Sample Text
                            </button>
                        </div>
                        <div class="sample-text" style="display: none;">"${book.sample_paragraph}"</div>
                        <div class="audio-controls">
                            <button class="audio-btn" onclick="playAudio('${book.sample_audio_path}', this)">
                                Listen Sample
                            </button>
                            <button class="audio-btn" onclick="playAudio('${book.book_talk_audio_path}', this)">
                                Full Book Talk
                            </button>
                        </div>
                    </div>

                    <div class="formal-models">
                        <div class="formal-models-title">Formal Models</div>
                        ${book.formal_models.map(model => `<span class="formal-model-tag">${model}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function filterBooks(filter) {
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            currentFilter = filter;
            let filteredBooks = allBooks;

            if (filter === 'B1') {
                filteredBooks = allBooks.filter(book => book.cefr_level === 'B1');
            } else if (filter === 'B2') {
                filteredBooks = allBooks.filter(book => book.cefr_level === 'B2');
            }

            displayBooks(filteredBooks);
        }

        let currentAudio = null;
        let currentButton = null;

        function playAudio(audioPath, buttonElement) {
            // Check if clicking the same button that's currently playing
            if (currentButton === buttonElement && currentAudio) {
                if (currentAudio.paused) {
                    // Resume playback
                    currentAudio.play().catch(error => {
                        console.error('Audio resume failed:', error);
                        resetAudioButton(buttonElement);
                    });
                    buttonElement.textContent = buttonElement.textContent.includes('Sample') ? 'Playing Sample...' : 'Playing Book Talk...';
                } else {
                    // Pause playback
                    currentAudio.pause();
                    buttonElement.textContent = buttonElement.textContent.includes('Sample') ? 'Resume Sample' : 'Resume Book Talk';
                }
                return;
            }

            // Stop current audio if playing different button
            if (currentAudio) {
                currentAudio.pause();
                if (currentButton) {
                    resetAudioButton(currentButton);
                }
            }

            // Play new audio
            // 如果audioPath是完整URL（以http开头），直接使用；否则拼接API_BASE_URL
            const audioUrl = audioPath.startsWith('http') ? audioPath : `${API_BASE_URL}/${audioPath}`;
            currentAudio = new Audio(audioUrl);
            currentButton = buttonElement;

            buttonElement.textContent = buttonElement.textContent.includes('Sample') ? 'Playing Sample...' : 'Playing Book Talk...';

            currentAudio.play().catch(error => {
                console.error('Audio playback failed:', error);
                buttonElement.textContent = 'Audio Error';
                setTimeout(() => {
                    resetAudioButton(buttonElement);
                }, 2000);
            });

            currentAudio.onended = () => {
                resetAudioButton(buttonElement);
                currentAudio = null;
                currentButton = null;
            };
        }

        function resetAudioButton(buttonElement) {
            const isSample = buttonElement.textContent.includes('Sample') || buttonElement.textContent.includes('Resume Sample');
            buttonElement.textContent = isSample ? 'Listen Sample' : 'Full Book Talk';
        }

        function toggleSampleText(buttonElement) {
            // Find the sample text element (next sibling)
            const sampleText = buttonElement.parentElement.nextElementSibling;

            if (sampleText.style.display === 'none') {
                // Show text
                sampleText.style.display = 'block';
                buttonElement.textContent = 'Hide Sample Text';
            } else {
                // Hide text
                sampleText.style.display = 'none';
                buttonElement.textContent = 'Show Sample Text';
            }
        }

        // User management (shared across pages)
        let currentUser = null;
        let authToken = null;

        // Check for saved authentication
        function checkAuth() {
            const savedToken = localStorage.getItem('authToken');
            const savedUser = localStorage.getItem('currentUser');

            if (savedToken && savedUser) {
                authToken = savedToken;
                currentUser = JSON.parse(savedUser);
                updateUserDisplay();
            }
        }

        // Update user display
        function updateUserDisplay() {
            const loggedOutControls = document.getElementById('loggedOutControls');
            const loggedInControls = document.getElementById('loggedInControls');
            const usernameDisplay = document.getElementById('usernameDisplay');

            if (currentUser) {
                loggedOutControls.style.display = 'none';
                loggedInControls.style.display = 'flex';
                usernameDisplay.textContent = `USER: ${currentUser.username.toUpperCase()}`;
            } else {
                loggedOutControls.style.display = 'flex';
                loggedInControls.style.display = 'none';
            }
        }

        // Redirect to main page for login/register
        function showModal(modalId) {
            window.location.href = `index.html#${modalId}`;
        }

        function hideModal(modalId) {
            // Not needed here since modals are on main page
        }

        // Logout function
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            updateUserDisplay();
            console.log('Logged out successfully!');
        }

        // Initialize
        window.onload = function() {
            checkAuth(); // Check for saved authentication
            loadBookGallery();
            console.log('Book Talk Gallery loaded');
        };

        // Language switching functionality
        const translations = {
            en: {
                'gallery-title': 'BOOK TALK GALLERY',
                'gallery-desc': 'Discover classic novels with difficulty levels, sample readings, and expert book talks.<br>Perfect for English learners who want to explore literature through <strong>formal models</strong> and <strong>CEFR difficulty ratings</strong>.',
                'filter-all': 'ALL BOOKS',
                'filter-b1': 'B1 LEVEL',
                'filter-b2': 'B2 LEVEL',
                'loading-text': '🔄 LOADING BOOK GALLERY...',
                'error-text': '❌ Failed to load book gallery<br>Please try again later.',
                'no-books': '📚 No books found for this filter',
                'sample-title': 'Sample Paragraph',
                'show-sample': 'Show Sample Text',
                'hide-sample': 'Hide Sample Text',
                'listen-sample': 'Listen Sample',
                'full-book-talk': 'Full Book Talk',
                'playing-sample': 'Playing Sample...',
                'playing-book-talk': 'Playing Book Talk...',
                'resume-sample': 'Resume Sample',
                'resume-book-talk': 'Resume Book Talk',
                'audio-error': 'Audio Error',
                'formal-models': 'Formal Models',
                'lang-btn': '中文',
                'level-suffix': ' Level',
                'words-suffix': ' Words'
            },
            zh: {
                'gallery-title': '书籍音频画廊',
                'gallery-desc': '发现经典小说，包含难度等级、示例阅读和专家书评。<br>为想要通过<strong>正式模型</strong>和<strong>CEFR难度评级</strong>探索文学的英语学习者量身定制。',
                'filter-all': '所有书籍',
                'filter-b1': 'B1 级别',
                'filter-b2': 'B2 级别',
                'loading-text': '🔄 加载书籍画廊中...',
                'error-text': '❌ 书籍画廊加载失败<br>请稍后重试。',
                'no-books': '📚 未找到符合此筛选条件的书籍',
                'sample-title': '示例段落',
                'show-sample': '显示示例文本',
                'hide-sample': '隐藏示例文本',
                'listen-sample': '收听示例',
                'full-book-talk': '完整书评',
                'playing-sample': '播放示例中...',
                'playing-book-talk': '播放书评中...',
                'resume-sample': '继续示例',
                'resume-book-talk': '继续书评',
                'audio-error': '音频错误',
                'formal-models': '正式模型',
                'lang-btn': 'EN',
                'level-suffix': ' 级别',
                'words-suffix': ' 词汇'
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'en';

        function updateLanguage() {
            const lang = translations[currentLanguage];

            // Update static elements
            document.querySelector('.gallery-header').innerHTML = lang['gallery-title'];
            document.querySelector('.gallery-desc').innerHTML = lang['gallery-desc'];

            // Update filter buttons
            const filterBtns = document.querySelectorAll('.filter-btn');
            if (filterBtns.length >= 3) {
                filterBtns[0].textContent = lang['filter-all'];
                filterBtns[1].textContent = lang['filter-b1'];
                filterBtns[2].textContent = lang['filter-b2'];
            }

            // Update language switcher button
            const langBtn = document.querySelector('.lang-switch');
            if (langBtn) {
                langBtn.textContent = lang['lang-btn'];
            }

            // Update any existing dynamic content
            updateDynamicContent();
        }

        function updateDynamicContent() {
            const lang = translations[currentLanguage];

            // Update loading/error messages if present
            const loadingText = document.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = lang['loading-text'];
            }

            const errorText = document.querySelector('.error-text');
            if (errorText) {
                errorText.innerHTML = lang['error-text'];
            }

            // Update sample sections
            document.querySelectorAll('.sample-title').forEach(el => {
                el.textContent = lang['sample-title'];
            });

            document.querySelectorAll('.formal-models-title').forEach(el => {
                el.textContent = lang['formal-models'];
            });

            // Update toggle buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                const isHidden = btn.parentElement.nextElementSibling.style.display === 'none';
                btn.textContent = isHidden ? lang['show-sample'] : lang['hide-sample'];
            });

            // Update audio buttons
            document.querySelectorAll('.audio-btn').forEach(btn => {
                const text = btn.textContent;
                if (text.includes('Listen Sample') || text.includes('收听示例')) {
                    btn.textContent = lang['listen-sample'];
                } else if (text.includes('Full Book Talk') || text.includes('完整书评')) {
                    btn.textContent = lang['full-book-talk'];
                } else if (text.includes('Playing Sample') || text.includes('播放示例')) {
                    btn.textContent = lang['playing-sample'];
                } else if (text.includes('Playing Book Talk') || text.includes('播放书评')) {
                    btn.textContent = lang['playing-book-talk'];
                } else if (text.includes('Resume Sample') || text.includes('继续示例')) {
                    btn.textContent = lang['resume-sample'];
                } else if (text.includes('Resume Book Talk') || text.includes('继续书评')) {
                    btn.textContent = lang['resume-book-talk'];
                } else if (text.includes('Audio Error') || text.includes('音频错误')) {
                    btn.textContent = lang['audio-error'];
                }
            });
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'zh' : 'en';
            localStorage.setItem('language', currentLanguage);
            updateLanguage();
        }

        // Update the resetAudioButton function to use translations
        function resetAudioButton(buttonElement) {
            const lang = translations[currentLanguage];
            const isSample = buttonElement.textContent.includes('Sample') || buttonElement.textContent.includes('示例');
            buttonElement.textContent = isSample ? lang['listen-sample'] : lang['full-book-talk'];
        }

        // Update the toggleSampleText function to use translations
        function toggleSampleText(buttonElement) {
            const lang = translations[currentLanguage];
            const sampleText = buttonElement.parentElement.nextElementSibling;

            if (sampleText.style.display === 'none') {
                sampleText.style.display = 'block';
                buttonElement.textContent = lang['hide-sample'];
            } else {
                sampleText.style.display = 'none';
                buttonElement.textContent = lang['show-sample'];
            }
        }

        // Update the playAudio function to use translations
        function playAudio(audioPath, buttonElement) {
            const lang = translations[currentLanguage];

            if (currentButton === buttonElement && currentAudio) {
                if (currentAudio.paused) {
                    currentAudio.play().catch(error => {
                        console.error('Audio resume failed:', error);
                        resetAudioButton(buttonElement);
                    });
                    const isSample = buttonElement.textContent.includes('Sample') || buttonElement.textContent.includes('示例');
                    buttonElement.textContent = isSample ? lang['playing-sample'] : lang['playing-book-talk'];
                } else {
                    currentAudio.pause();
                    const isSample = buttonElement.textContent.includes('Sample') || buttonElement.textContent.includes('示例');
                    buttonElement.textContent = isSample ? lang['resume-sample'] : lang['resume-book-talk'];
                }
                return;
            }

            if (currentAudio) {
                currentAudio.pause();
                if (currentButton) {
                    resetAudioButton(currentButton);
                }
            }

            const audioUrl = audioPath.startsWith('http') ? audioPath : `${API_BASE_URL}/${audioPath}`;
            currentAudio = new Audio(audioUrl);
            currentButton = buttonElement;

            const isSample = buttonElement.textContent.includes('Sample') || buttonElement.textContent.includes('示例');
            buttonElement.textContent = isSample ? lang['playing-sample'] : lang['playing-book-talk'];

            currentAudio.play().catch(error => {
                console.error('Audio playback failed:', error);
                buttonElement.textContent = lang['audio-error'];
                setTimeout(() => {
                    resetAudioButton(buttonElement);
                }, 2000);
            });

            currentAudio.onended = () => {
                resetAudioButton(buttonElement);
                currentAudio = null;
                currentButton = null;
            };
        }

        // Update displayBooks function to use translations
        function displayBooks(books) {
            const lang = translations[currentLanguage];
            const grid = document.getElementById('booksGrid');
            if (books.length === 0) {
                grid.innerHTML = `<div class="error-text">${lang['no-books']}</div>`;
                return;
            }

            grid.innerHTML = books.map(book => `
                <div class="book-card" data-cefr="${book.cefr_level}">
                    <div class="book-header">
                        <div class="book-cover">
                            <img src="${book.cover_url}" alt="${book.title}"
                                 onerror="this.style.display='none'; this.parentElement.innerHTML='📚';">
                        </div>
                        <div class="book-info">
                            <div class="book-title">${book.title}</div>
                            <div class="book-author">by ${book.author}</div>
                            <div class="book-meta">
                                <span class="meta-tag difficulty-tag">${book.cefr_level}${lang['level-suffix']}</span>
                                <span class="meta-tag vocab-tag">${book.estimated_vocabulary.toLocaleString()}${lang['words-suffix']}</span>
                                <span class="meta-tag genre-tag">${book.genre}</span>
                            </div>
                        </div>
                    </div>

                    <div class="sample-section">
                        <div class="sample-title">${lang['sample-title']}</div>
                        <div class="sample-toggle">
                            <button class="toggle-btn" onclick="toggleSampleText(this)">
                                ${lang['show-sample']}
                            </button>
                        </div>
                        <div class="sample-text" style="display: none;">"${book.sample_paragraph}"</div>
                        <div class="audio-controls">
                            <button class="audio-btn" onclick="playAudio('${book.sample_audio_path}', this)">
                                ${lang['listen-sample']}
                            </button>
                            <button class="audio-btn" onclick="playAudio('${book.book_talk_audio_path}', this)">
                                ${lang['full-book-talk']}
                            </button>
                        </div>
                    </div>

                    <div class="formal-models">
                        <div class="formal-models-title">${lang['formal-models']}</div>
                        ${book.formal_models.map(model => `<span class="formal-model-tag">${model}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Update loadBookGallery to use translations for loading messages
        async function loadBookGallery() {
            try {
                const response = await apiRequest('/api/book-gallery');
                allBooks = response.books;

                displayBooks(allBooks);
                hideAudioLoadingMessage();

                if (response.audio_cache_empty) {
                    console.log('🎵 Audio cache is empty, generating audio in background...');
                    generateGalleryAudio().catch(error => {
                        console.warn('Background audio generation failed:', error);
                    });
                }
            } catch (error) {
                console.error('Failed to load book gallery:', error);
                const lang = translations[currentLanguage];
                document.getElementById('booksGrid').innerHTML =
                    `<div class="error-text">${lang['error-text']}</div>`;
                hideAudioLoadingMessage();
            }
        }

        // Initialize language on load
        window.onload = function() {
            checkAuth();
            updateLanguage(); // Set initial language
            loadBookGallery();
            console.log('Book Talk Gallery loaded');
        };
    </script>

    <!-- Language Switcher -->
    <button class="lang-switch" onclick="toggleLanguage()">中文</button>
</body>
</html>